name: AWS Terraform Workflow
on:
  workflow_dispatch:
  push:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BUCKET_NAME: github-actions-terraform-state-bucket
  DYNAMODB_TABLE_NAME: terraform-state-file-table

jobs:
  aws-terraform:
    runs-on: ubuntu-latest
    steps:
      - name: AuthN Agains AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::224732705809:role/github-actions-terraform
          aws-region: ${{ env.AWS_REGION }}
      - name: Create S3 Bucket
        run: |
          aws s3api create-bucket \
          --bucket ${{ env.BUCKET_NAME }} \
          --region ${{ env.AWS_REGION }} \
          --create-bucket-configuration \
          LocationConstraint=${{ env.AWS_REGION }}
      - name: Enable S3 Bucket Versioning
        run: |
          aws s3api put-bucket-versioning \
          --bucket ${{ env.BUCKET_NAME }} \
          --versioning-configuration Status=Enabled
      - name: Create DynamoDB Table
        run: |
          aws dynamodb create-table \
          --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
          --attribute-definitions AttributeName=LockID,AttributeType=S \
          --key-schema AttributeName=LockID,KeyType=HASH \
          --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
          --region ${{ env.AWS_REGION }}

      # - name: Checkout Code
      #   uses: actions/checkout@v4
      # - name: Intialize Terraform
      #   run: |
      #     terraform init
      # - name: Plan Terraform Config File
      #   run: |
      #     terraform plan
      # - name: Apply Terraform Config File
      #   run: |
      #     terraform apply -auto-approve
